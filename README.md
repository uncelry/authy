# authy



## Что такое notify?

notify - это часть системы авторизации, генерирующая JWT Access Token с поддержкой Refresh Token

## Стек

Приложение реализовано на стеке, включающем в себя следующие технологии:
- Для реализации приложения использован Django
- API разработано при помощи Django Rest Framework
- Для хранения Refresh токенов в БД используется алгоритм bcrypt
- Приложение разворачивается на Uvicorn

## Принцип работы

Приложение использует БД PostgreSQL.

В приложении имеется 1 модель - Client. Она хранит в себе записи о клиентах (псевдо-пользователях)
Данная модель состоит из следующих полей:
- id (pk) - ключ записи пользователя
- refresh - хэш Refresh токена текущего пользователя
- public_id - UUID пользователя (именно он передается в API запросе)

Приложение состоит из 2-х представлений:

Представление **generate_tokens_view** принимает в теле POST запроса параметр *user_id*, который указывает UUID пользователя, для которого производится генерация пары ключей. Если пользователь с таким UUID существует, то для него выдается новая пара ключей и возвращается статус 200 (OK/UPDATED). В случае, если пользователя с таким UUID нет в БД, он создается, и для него, аналогично, возвращается пара сгенерированных ключей со статусом 201 (CREATED).

Так как это приложение не является полноценным сервисом авторизации, то подразумевается, что запрос к данному представлению поступает из доверенного источника - в реальной системе авторизации необходимы бы была проверка логина/пароля или авторизации через соц. сети.

Представление **refresh_tokens_view** принимает в теле POST запроса параметр *rt*, который указывает Refresh Token пользователя. При получении Refresh токена происходит вычисление его хэша, и полученное значение ищется в БД. Если запись находится, для пользователя, которому соответствует текущий токен, происходит обновление пары Access Token и Refresh Token. Новые токены возвращаеются со статусом 200 (OK/UPDATED). В случае, если такого значения в БД не найдено, вовзращаем описание ошибки с кодом статуса 400 (BAD_REQUEST).

Приложение написано без использования сериализаторов DRF для упрощения читабельности кода.

## Получение Access Token (JWT)

JWT (Access Token) высчитывается при помощи функии **gen_jwt** из модуля **utilities** пакета приложения **api**. Сам JWT состоит из 3 частей:
1. Header (заголовок). Стандартно в данном приложении используется алгоритм SHA512, поэтому заголовок выглядит так: 
```
  header = {
      "alg": "HS512",
      "typ": "JWT"
  }
```

2. Payload (содержимое). В этой части передается информация - можно включать мета-данные и любые другие параметры. Функция **gen_jwt** позволяет задавать содержимое самостоятельно, однако имеет и стандартный раздел Payload по умолчанию. В нем передается id пользователя и время окончания действия Access Token'а (1 час от момента генерации). Он выглядит слеюущим образом:
```
payload = {
    "user_id": USER_ID,
    "iat": EXP_TIMESTAMP
}
```

3. Signature (подпись). Подпись - это хэшированное секретным ключем (по алгоритму SHA512) значение первых двух частей токена.

JWT получается **без** использования каких-либо сторонних библиотек для JWT аутентификации и **не** сохраняется в БД.

## Получение Refresh Token

Refresh Token - это обычное хэшированое значение, которое генерируется с использованием случайных значений. Все Refresh токены (и их хэши в БД) - уникальны.
За генерацию Refresh токенов отвечает функция **gen_rt**. За их хэширование при помощи *bcrypt* отвечает функция **hash_rt**.

## Принцип работы пар токенов Acces + Refresh

Основной смысл работы парных токенов заключается в задании разной продолжительности их жизни. Access Token, как правило, короткоживущий (в данном случае - 1 час). Refresh Token - долгоживущий (в данном случае - бессрочный). В реальных приложениях, при истечении времени жизни Access токена, при помощи Refresh токена запрашивается новый Acces токен. Refresh токен при этом, тоже обновляется.

## Описание API
Сервис работает на REST API. Root API находится по адресу "/api/"

Генерация токенов по UUID пользователя - "/api/auth/generate_tokens/". В теле POST указывается параметр {"user_id": UUID}
Обновление токенов по Refresh Token - "/api/auth/refresh_tokens/". В теле POST указывается параметр {"rt": REFRESH_TOKEN}

## Запуск проекта

Для запуска проекта необходимо выполнить следующие действия:

1. Клонировать репозиторий - ```git clone https://github.com/uncelry/authy.git```
2. В папке с проектом создать виртуальное окружение - ```python -m venv venv```
3. Активировать окружение - ```cd venv/Scripts/``` + ```activate```
4. Установить зависимости из requirements.txt - ```pip install -r requirements.txt```
5. Запустить локальный сервер Uvicorn - ```uvicorn notify.asgi:application --port 80 --no-access-log```
